---
  classes:
    - zookeeper

  zookeeper::service_provider: "exhibitor"
  zookeeper::install_method: "archive"
  zookeeper::archive_version: '3.4.10'
  zookeeper::client_ip: "%{::ipaddress}"
  zookeeper::cfg_dir: '/opt/zookeeper/conf'
  zookeeper::java_opts: '-Dkinesis.stream=els-srch-vi-test'

  exhibitor::zk_data_dir: '/var/lib/zookeeper/'
  exhibitor::zk_log_dir: '/var/log/zookeeper/log'
  exhibitor::zk_install_dir: '/opt/zookeeper/'
  exhibitor::auto_manage_instances: 1

  exhibitor::defaultfile_opts:
    defaultconfig: '/opt/exhibitor/exhibitor.conf'
    s3region: 'us-east-1'
    configtype: 's3'
    s3config: 'puppet_bucket_test:exhibitor'


  configs:
    /opt/zookeeper/conf/log4j.xml:
      owner: root
      group: root
      mode: '0644'
      content: |
        <?xml version="1.0" encoding="UTF-8" ?>
        <!DOCTYPE log4j:configuration SYSTEM "log4j.dtd">

        <log4j:configuration xmlns:log4j="http://jakarta.apache.org/log4j/">
          <appender name="file" class="org.apache.log4j.RollingFileAppender">
        	   <param name="append" value="false" />
        	   <param name="maxFileSize" value="10KB" />
        	   <param name="maxBackupIndex" value="5" />
        	   <!-- For Tomcat -->
        	   <param name="file" value="./zookeeper.log" />
        	   <layout class="org.apache.log4j.PatternLayout">
        		<param name="ConversionPattern"
        			value="%d{yyyy-MM-dd HH:mm:ss} %-5p %c{1}:%L - %m%n" />
        	   </layout>
        	</appender>

          <appender name="KINESIS" class="com.amazonaws.services.kinesis.log4j.KinesisAppender">
            <layout class="org.apache.log4j.PatternLayout">
              <param name="ConversionPattern" value"%d{yyyy-MM-dd HH:mm:ss} %-5p %c{1}:%L - %m%n" />
            </layout>
            <layout class="net.logstash.log4j.JSONEventLayoutV1">
                <param name="locationInfo" value="false"/>
                <param name="UserFields" value="application:Zookeeper"/>
            </layout>
            <param name="streamName" value="${kinesis.stream}" />
            <param name="encoding" value="UTF-8" />
            <param name="maxRetries" value="3" />
            <param name="bufferSize" value="1000" />
            <param name="threadCount" value="1" />
            <param name="shutdownTimeout" value="30" />
            <param name="endpoint" value="kinesis.us-east-1.amazonaws.com" />
            <param name="region" value="us-east-1" />
          </appender>

          <appender name="kinesis" class="org.apache.log4j.AsyncAppender">
              <param name="blocking" value="false"/>
              <appender-ref ref="KINESIS"/>
          </appender>

          <root>
              <priority value="info" />
              <appender-ref ref="file" />
              <appender-ref ref="kinesis"/>
          </root>

        </log4j:configuration>


      notify:
        - Exec[restart_zookeeper]
    "%{hiera('exhibitor::zk_install_dir')}lib/kinesis-log4j-appender-1.0.0.jar":
      owner: root
      group: root
      mode: '0644'
      source: http://emr-kinesis.s3.amazonaws.com/publisher/kinesis-log4j-appender-1.0.0.jar
      notify:
        - File[/opt/zookeeper/conf/log4j.xml]
        - Exec[restart_zookeeper]
